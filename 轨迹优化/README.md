# 轨迹优化插值方法

目的：**已知一些离散点，插值出一些新的点，使得所有点形成一条平滑曲线**

对于轨迹“平滑”，通常有不同的约束

1. 要求生成的曲线是连续的
2. 在1的基础上，要求参考曲线的速度是连续的
3. 在1和2的基础上，要求参考曲线的加速度是连续的

对于轨迹 $q$ 而言

$$
s = q(t) \\
v = \dot{q}(t) \\
a = \ddot{q}(t) \\
jerk = \dddot{q}(t) \\
$$

## 多项式插值

## 贝塞尔曲线插值

假如有 $n+1$ 个控制点 $P_0,P_1,\cdots,P_n$ 这$ n+1$ 个点可以确定一条 $n$ 次贝塞尔曲线，如下式所示

$$
B(t)=\sum_{i=0}^{n}{C_{n}^{i}(1-t)^{n-i}t^iP_i} \quad t \in [0,1]
$$

其中

$$
C_n^i=\frac{n!}{i!(n-i)!}
$$

例如，二次贝塞尔曲线

$$
B(t) = (1-t)^2P_0+2(1-t)tP_1 + t^2P_2 \quad t \in [0,1]
$$

三次贝塞尔曲线

$$
B(t) = (1-t)^3P_0 + 3(1-t)^2tP_1+ 3(1-t)t^2P_2 + t^3P_3 \quad t \in [0,1]
$$

对于三次贝塞尔曲线而言：

$t=0, B(0)=P_0; t=1, B(1) = P_3$ ，满足了起点和终点的条件

还需要额外知道两个控制点的信息（通常由速度大小和速度方向提供）

 常用方法：指定起点点起点和终点的切线方向
起点的一阶导数与控制点有关系

- 曲线在$P_0$点的切线方向与向量$P_1 - P_0$ 平行
- 曲线在$P_3$ 点的切线方向与向量 $ P_2 - P_3$ 平行

引入权重参数，切向量的模长决定控制点离锚点$(P_0, P_3)$ 的远近程度，从而控制曲线的“紧绷”程度。模长越长，曲线在离开锚点时越冲，形成的曲线越膨大。模长越短，曲线越贴近锚点之间

计算控制点如下

- $P_1 = P_0 + (\frac{\alpha}{3})\times T_0$
- $P_2 = P_3 - (\frac{\beta}{3})\times T_3$
  其中， $\alpha, \beta$用来控制模长，$T_0, T_3$表示$P_0, P_3$处的切向量

给定五个点进行贝塞尔曲线插值$P_0, P_1, P_2, P_3, P_4$ ,则需要四段三次贝塞尔曲线
首先需要满足$C1$ 连续性, 以为着i - 1段的控制点与第 i 段控制点关于 $P_i$ 对称

**切线约束**： $P_i$ 点处的切线方向与该点前后两点的连线方向相同

$$
T_i = k(P_{i+1} - P_{i-1})
$$

对于端点而言，需要单独指定切线方向，或者使用自然边界条件（二阶导数为0）

贝塞尔曲线需要注意：

- 贝塞尔曲线是通过控制点生成的，控制点不全在最终曲线上
- 控制点首尾的两点是最终曲线的端点（**首尾两个端点一定在曲线上**），且各自与相邻点的连线同最终曲线相切
- 两个贝塞尔曲线如果平滑连接，则需要连接点与其左右相邻两端点共线

三次贝塞尔曲线和五次贝塞尔曲线的优缺点三次：

1. 计算效率高
2. 数值稳定性好
3. 移动一个控制点只会影响曲线一部分

五次（由六个控制点控制）：

1. 更好的连续性
2. 在机器人运动规划中，可以同时指定位置、速度、加速度

快速计算方法 德卡斯特里奥 算法
**de Casteljau**例如对三次贝塞尔曲线四个控制点 $P_0, P_1, P_2, P_3$

1. 首先用直线连接四个控制点

$$
P_0^{(0)} = P_0 \\  
P_1^{(0)} = P_1 \\  
P_2^{(0)} = P_2 \\  
P_3^{(0)} = P_3
$$

2. 通过相邻两点分配权重构建一个新的点

$$
P_0^{(1)} = (1-t)P_0^{(0)} + tP_1^{(0)} \\  
P_1^{(1)} = (1-t)P_1^{(0)} + tP_2^{(0)} \\  
P_2^{(1)} = (1-t)P_2^{(0)} + tP_3^{(0)} \\
$$

3. 再由上述方法构建新的两个点

$$
P_0^{(2)} = (1-t)P_0^{(1)} + tP_1^{(1)} \\ 
P_1^{(2)} = (1-t)P_1^{(1)} + tP_2^{(1)}
$$

4. 最终构建出 $B(t)$

$$
B(t) = P_0^{(3)} = (1-t)P_0^{(2)} + tP_1^{(2)}
$$

5. 最后逐个变量代入

$$
B(t) = P₀⁽³⁾ = (1-t)P₀⁽²⁾ + tP₁⁽²⁾ \\  
            = (1-t)[(1-t)²P₀ + 2t(1-t)P₁ + t²P₂] + t[(1-t)²P₁ + 2t(1-t)P₂ + t²P₃] \\  
            = (1-t)³P₀ + 3t(1-t)²P₁ + 3t²(1-t)P₂ + t³P₃
$$

## B样条插值

[B样条曲线解释](https://ikerlz.github.io/post/spline/#2b-splines)

需要自己选取控制点

优点：
1. 局部控制性：移动一个控制点只会影响曲线的局部区域，不会影响整条曲线
2. 平滑性，曲线再连接处非常平滑，没有尖锐的转折
3. 不一定经过控制点：与折线不同，B样条曲线通常不会直接穿过所有控制点，而是被吸引



B样条曲线是贝塞尔曲线的一种推广，由控制点和B样条基函数定义  ,具有n+1个控制点 $\{P_0, P_1, P_2, \cdots , P_n \}$   
**节点向量**：非递减的实数序列 $U = \{u_0, u_1, \cdots, u_m \}$ 其中 $m = n + k + 1$ ,( $n+1$ 是控制点的数量， $ k $ 是曲线的次数 )  ，节点与控制点无关，是人为的将曲线分为若干个部分
最常用的是二次和三次B样条

$$
C(u) = \sum_{i=0}^{n}N_{i,k}(u)P_i
$$

其中， $N_{i,k}(u) $ 是第i个k次B样条基函数

对于零次基函数










